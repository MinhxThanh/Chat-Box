(()=>{var e="undefined"!=typeof browser?browser:chrome,t=null,n=!1;e.tabs.onActivated.addListener((function(e){var n=e.tabId;return t=n})),e.tabs.onRemoved.addListener((function(e){e===t&&(t=null)}));var i=null;if(e.sidePanel&&e.sidePanel.setPanelBehavior)try{e.sidePanel.setPanelBehavior({openPanelOnActionClick:!0})}catch(e){console.error(e)}function s(t,s){if(s)if(e.sidePanel&&e.sidePanel.setOptions&&e.sidePanel.open)e.sidePanel.setOptions({tabId:t,path:"sidebar.html",enabled:!0},(function(){e.sidePanel.open({tabId:t}),i=t,n=!0,d()}));else if(e.sidebarAction&&e.sidebarAction.open)e.sidebarAction.open(),i=t,n=!0,d();else{var a=e.runtime.getURL("sidebar.html");e.tabs.create({url:a})}else e.sidePanel&&e.sidePanel.setOptions?e.sidePanel.setOptions({tabId:t,enabled:!1},(function(){i=null,n=!1,d()})):e.sidebarAction&&e.sidebarAction.close&&(e.sidebarAction.close(),i=null,n=!1,d())}function a(){n=!1,d(),e.tabs.query({},(function(t){t.forEach((function(t){t.url&&(t.url.startsWith("http:")||t.url.startsWith("https:"))&&e.tabs.sendMessage(t.id,{action:"forceSidebarClose"})}))})),console.log("Attempted to send force close signal to relevant tabs"),i&&(e.sidePanel&&e.sidePanel.setOptions?e.sidePanel.setOptions({tabId:i,enabled:!1},(function(){i=null})):e.sidebarAction&&e.sidebarAction.close&&(e.sidebarAction.close(),i=null))}e.commands.onCommand.addListener((function(s){if("toggle_sidebar"===s&&t)if(n&&i===t)e.sidePanel&&e.sidePanel.setOptions?e.sidePanel.setOptions({tabId:t,enabled:!1}):e.sidebarAction&&e.sidebarAction.close&&e.sidebarAction.close(),n=!1,i=null,d();else if(e.sidePanel&&e.sidePanel.setOptions&&e.sidePanel.open)e.sidePanel.setOptions({tabId:t,path:"sidebar.html",enabled:!0},(function(){return e.sidePanel.open({tabId:t})})),n=!0,i=t,d();else if(e.sidebarAction&&e.sidebarAction.open)e.sidebarAction.open(),n=!0,i=t,d();else{var a=e.runtime.getURL("sidebar.html");e.tabs.create({url:a})}})),e.runtime.onMessage.addListener((function(e,t,i){"openSidebar"===e.action&&t.tab&&s(t.tab.id,!0),"checkSidebarStatus"===e.action&&i({isOpen:n})}));var o=function(t){if(console.log("Extension icon clicked, opening sidebar for tab:",t.id),e.sidePanel&&e.sidePanel.setOptions&&e.sidePanel.open)e.sidePanel.setOptions({tabId:t.id,path:"sidebar.html",enabled:!0},(function(){e.sidePanel.open({tabId:t.id},(function(){console.log("Sidebar opened successfully from icon click"),i=t.id,n=!0,d()}))}));else if(e.sidebarAction&&e.sidebarAction.open)e.sidebarAction.open(),i=t.id,n=!0,d();else{var s=e.runtime.getURL("sidebar.html");e.tabs.create({url:s})}};function d(){e.tabs.query({},(function(t){t.forEach((function(t){t.url&&(t.url.startsWith("http:")||t.url.startsWith("https:"))&&e.tabs.sendMessage(t.id,{action:"sidebarStatusChanged",isOpen:n})}))}))}e.action&&e.action.onClicked?e.action.onClicked.addListener(o):e.browserAction&&e.browserAction.onClicked&&e.browserAction.onClicked.addListener(o),e.runtime.onMessage.addListener((function(t,n,o){if("openSidebar"===t.action){console.log("Received openSidebar message from content script");var d=(l=n.tab.id,n.tab.windowId,console.log("Attempting to open sidebar for tab:",l),s(l,!0),!0);return o({success:d}),!0}var l,r;if("closeSidebar"===t.action){var c;console.log("Received closeSidebar message from content script");var b=(r=null===(c=n.tab)||void 0===c?void 0:c.windowId,console.log("Attempting to close sidebar"),null!==i?(s(i,!1),!0):r?(e.tabs.query({active:!0,windowId:r},(function(e){e&&e.length>0?s(e[0].id,!1):a()})),!0):(a(),!0));return o({success:b}),!0}return"getSettings"!==t.action||(e.storage.local.get("aiChatSettings",(function(e){o(e.aiChatSettings||null)})),!0)})),e.tabs.onUpdated.addListener((function(t,n,i){"complete"===n.status&&i.url&&i.url.includes("youtube.com/watch")&&e.scripting&&e.scripting.executeScript&&e.scripting.executeScript({target:{tabId:t},files:["contentScript.js"]})})),e.tabs.onActivated.addListener((function(e){console.log("Tab activated:",e.tabId),null!==i&&i!==e.tabId?(console.log("User switched to tab without sidebar, tab ID:",e.tabId),n=!1,d()):i===e.tabId&&(console.log("User switched back to tab with sidebar, tab ID:",e.tabId),n=!0,d())})),e.runtime.onInstalled.addListener((function(t){console.log("Extension installed or updated:",t.reason),"install"===t.reason&&e.storage.local.set({aiChatSettings:{apiKey:"no-api-key",endpoint:"http://localhost:11434",models:[],selectedModel:"gemma3"}})}))})();